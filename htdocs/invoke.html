<html>
<!-- $Id: invoke.html,v 1.9 1999/06/29 07:44:33 qfwfq Exp $ -->

<head>
<meta http-equiv="Content-Type" content="text/html; charset=ISO-2022-JP">
<title>rhizome/pi usages</title>
</head>

<body>
<ul>
  <li><a href="#Pi">pi</a>
  <li><a href="#Piw">piw</a>
  <li><a href="#Pisc">pisc</a>
  <li><a href="#Pisf">pisf</a>
  <li><a href="#Pisl">pisl</a>
</ul>

<a name="Pi"><h2>pi</h2></a>
  pi は scheme インタプリタである。
<p>
<dl>
  <dt>起動方法
  <dd><code>pi [<var>file</var>] [<var>arguments</var>]</code>
</dl>
<p>
  引数なしで起動した場合、pi は通常の read-eval-print ループを実行する。
  式 <code>(exit)</code> を評価することで終了する。<br>
  起動時に引数を与えた場合、それが "--" でなければ第一引数をファイル名
  として解釈し、read-eval-print ループの実行に先だってそのファイルを
  ロードする。
  第二引数以降はアプリケーションにパラメータを与えるために利用できる。
  プログラムからコマンドラインの引数を知るには大域変数
  <code>*invocation-arg*</code> または手続き
  <code>rp:command-line-arguments</code> を使用する。
  pi に引数を与えるがファイルのロードは行わない場合は第一引数として "--"
  を指定する。pi が引数なし、あるいは "--" を第一引数として起動された場合、
  環境変数 RHIZOME_PI_RC がセットされていればその内容が read-eval-print
  ループの実行に先だって評価される。<br>
  pi の動作は標準ライブラリに含まれるモジュール rp_pi が行なっている。pisl
  の最後の引数として rp_pi: を指定することで他のモジュールに含まれる手続きが
  コンパイル済みで追加されたインタプリタを作成できる。特にコマンド
  "pisl rp_pi:" を実行することで pi そのものと同じ実行プログラムが作られる。
  モジュール rp_pi の動作の詳細は以下のとおりである。
  <ol compact start="0">
  <li>実行前に <code>*invocation-arg*</code>
      にはコマンドラインがセットされている。
  <li>第一引数が "--" であればそれを <code>*invocation-arg*</code>
      から取り除く。
      それ以外の第一引数が指定されていれば第ゼロ引数(コマンド名)を
      <code>*invocation-arg*</code> から取り除く。
      引数がなければ <code>*invocation-arg*</code> はそのままにしておく。
  <li><ol compact type="a">
      <li>引数が無いか第一引数が "--" であったなら環境変数 RHIZOME_PI_RC
	  を調べ、セットされていればその値を評価する。
      <li>"--" 以外の第一引数が指定されていればそれをロードする。
      </ol>
  <li type="A" value="24">
      ステップ2が終了し pi の実行が続いていれば、手続き break (即ち
      read-eval-print ループ)がプロンプトを <code>*invocation-arg*</code>
      の car から取って呼ばれる。この動作自体はモジュール rp_pi
      が行なうものではなく、モジュール rp_pi
      がリンクされているかどうかにかかわらず常に行なわれる。
  </ol>
<p>
<dl>
  <dt><code>*invocation-arg*</code> 大域変数
  <dd>初期状態では起動時のコマンドラインをリストとして保持している。これは
      インタプリタ pi では第一引数(ロードするファイル)以降の文字列からなる
      リストであり、コンパイルされたプログラムでは実行ファイル名を含む
      コマンドライン全体からなるリストである。いずれの場合でもリストの第二
      要素以降をプログラムに対する引数として扱えばよいので、プログラムを
      インタプリタで実行する場合でもコンパイルされている場合でも引数の取得
      は同様に行えばよい。<br>
      なお、これは単なる変数なのでいつでも代入して値を変えることができる。
  <p>
  <dt><code>(rp:command-line-arguments)</code> 手続き
  <dd>起動時のコマンドラインをベクタとして返す。これは常にコマンドライン
      全体となる。この手続きの返す値を変更する手段はない(定義自体を上書き
      する場合を除いて。)
</dl>
<p>
例
<pre>
$ cat arg.scm
(display "*invocation-arg* is               ")
(write *invocation-arg*)
(newline)
(display "rp:command-line-arguments returns ")
(write (rp:command-line-arguments))
(newline)
(exit)
$ pi arg.scm foo bar baz
*invocation-arg* is               ("arg.scm" "foo" "bar" "baz")
rp:command-line-arguments returns #("pi" "arg.scm" "foo" "bar" "baz")
$ pisc arg.scm
$ pisl arg
gcc -O2 -m486 -I/u/qfwfq/lib/rhizome -c arg.c
gcc -O2 -m486 -I/u/qfwfq/lib/rhizome -c a.c
gcc -L/u/qfwfq/lib/rhizome a.o arg.o -lrhzscm -lrhzpi -lrhizome -lm
$ ./a.out foo bar baz
*invocation-arg* is               ("./a.out" "foo" "bar" "baz")
rp:command-line-arguments returns #("./a.out" "foo" "bar" "baz")
</pre>

<a name="Piw"><h2>piw</h2></a>
  piw はWin32版にのみ存在する。pi と同様 scheme インタプリタであり、
  起動方法に違いはない。pi と piw の違いは以下に述べる点のみである。
<p>
<ul>
  <li>pi はコンソールアプリケーションであるが
      piw はGUIアプリケーションとして作成されている。
      pisl の -windows オプションの項を参照。
  <li>piw にはウィンドウズアプリケーション作成用のライブラリ
      (<a href="wwlib.txt">wwライブラリ</a>)がリンクされている。
</ul>

<a name="Pisc"><h2>pisc</h2></a>
  pisc は scheme コンパイラである。scheme プログラムをC言語のプログラムに
  変換する。
<p>
<dl>
  <dt>起動方法
  <dd><dl>
	<dt><code>pisc -help</code>
	<dd>コマンドラインの書式の簡単な説明を出力する。
	<dt><code>pisc [<var>options</var>] <var>file</var>
	<dd><code><var>file</var></code> をC言語のプログラムに変換する。
      </dl>
</dl>
<p>
オプション:
<dl>
  <dt><code>-module <var>module-identifier</var></code>
  <dd>モジュール名を <code><var>module-identifier</var></code> とする。
      モジュール名は pisl で実行ファイルを生成する時に指定する名前である。
      これはC言語の識別子として正当なものでなければならない。
      デフォルトではソースファイルの名前から末尾の ".scm" を
      (もしあれば)除いたものとなる。
  <dt><code>-output <var>filename</var></code>
  <dd>出力するファイルの名前を指定する。デフォルトではモジュール
      名の末尾に ".c" を加えたものとなる。
  <dt><code>-mpath <var>dir</var></code>
  <dd><code><var>dir</var></code> を <code>rp:use-macro-package</code>
      のサーチパスに加える。このオプションは複数指定できる。
  <dt><code>-load <var>filename</var></code>
  <dd>ソースの読み込みの前に指定されたファイルをコンパイラの実行
      環境にロードする。コンパイル時にマクロの組み込みを行う目的
      に使用できる。このオプションは複数指定できる。
</dl>

<a name="Pisf"><h2>pisf</h2></a>
  pisf は scheme プログラムを(多くのケースで)ロードしやすい表現に変換する。
  生成されるファイルはソースファイルと同様に load 手続きによってロード
  できるが人が読むには適さない。通常はソースファイルより小さなファイルを
  出力するが、変換過程でマクロの展開を行うため逆に巨大なファイルを出力する
  可能性もある。(マクロ展開後の)プログラムのサイズが大きいと pisf の実行
  自体にかなりの時間がかかることがある。オプションによってロード可能なファイル
  ではなくC言語のプログラムを出力することも可能である。この場合通常は pisc
  で生成するよりもかなり小さなプログラムが得られるが、ソースファイルの内容は
  インタプリタによって実行されることになる。
<p>
<dl>
  <dt>起動方法
  <dd><dl>
	<dt><code>pisf -help</code>
	<dd>コマンドラインの書式の簡単な説明を出力する。
	<dt><code>pisf [<var>options</var>] <var>file</var></code>
	<dd><code><var>file</var></code> を変換する。
      </dl>
</dl>
<p>
オプション:
<dl>
  <dt><code>-exec <var>interpreter</var></code>
  <dd>実行可能なスクリプトを出力する(unix 系のOSでのみ意味を持つ)。
      <code><var>interpreter</var></code>
      にはプログラムを実行すべき実行ファイルのフルパスを指定する。
      出力されるファイルの一行目は "#!<code><var>interpreter</var></code>"
      の形になる。
  <dt><code>-module <var>module-identifier</var></code>
  <dd>C言語のプログラムを出力する。
      <code><var>module-identifier</var></code>は pisc
      で指定するのと同様の意味を持ち、生成されたファイルは
      pisc の出力と同様に pisl にモジュールとして指定する。
  <dt><code>-output <var>filename</var></code>
  <dt><code>-mpath <var>dir</var></code>
  <dt><code>-load <var>filename</var></code>
  <dd>これらのオプションの意味は pisc と同じ。
</dl>

<a name="Pisl"><h2>pisl</h2></a>
  pisl は pisc によって生成されたC言語のプログラムをコンパイルし、ランタイム
  ライブラリとリンクして実行ファイルを生成する。
<p>
<dl>
  <dt>起動方法
  <dd><dl>
	<dt><code>pisl -help</code>
	<dd>コマンドラインの書式の簡単な説明を出力する。
	<dt><code>pisl [<var>options</var>] <var>module-specifier</var> ...</code>
	<dd><code><var>module-specifier</var></code> で指定されるモジュールを
	    結合して実行ファイルを生成する。
      </dl>
</dl>
<p>
オプション:
<dl>
  <dt><code>-cc <var>cc-command-line</var></code>
  <dd>C コンパイラのコマンドラインを指定する。デフォルトは
      <code>pisl -help</code> の出力で知ることができる。
  <dt><code>-ld <var>ld-command-line</var></code>
  <dd>リンカのコマンドラインを指定する。デフォルトは <code>pisl -help</code>
      の出力で知ることができる。
  <dt><code>-nold</code>
  <dd>リンカの起動を抑制する。
  <dt><code>-nolib</code>
  <dd>デフォルトのランタイムライブラリの指定を抑制する。この指定
      が無い時にリンクされるライブラリは <code>pisl -help</code> の出力で知る
      ことができる。
  <dt><code>-loadable</code>
  <dd>実行ファイルではなく共有オブジェクトを生成する。生成されたオブジェクトは
      <code>rp:load-compiled-module</code>手続きによりロードする。
      環境によってはこのオプションは使用できない。
  <dt><code>-static</code>
  <dd>生成される実行ファイルを特定の共有オブジェクトに依存しないで
      実行できるものにする。ファイルサイズは大きくなる。
      環境によってはこのオプションは常に有効になる。
  <dt><code>-modlib</code>
  <dd>さらに pisl を実行する時にモジュールが含まれる入力ファイルと
      して使用できる共有オブジェクトを作成する。
      環境によってはこのオプションは使用できない。
  <dt><code>-windows</code>
  <dd>このオプションはWin32でのみ意味を持つ。指定された場合Win32の
      GUIアプリケーションが生成される。生成された実行ファイルは
      コンソールから切り離されて起動し、最初にコンソールからの
      入出力を行った時に自身のコンソールを持つようになる。
  <dt><code>-o <var>filename</var></code>
  <dd>出力する実行ファイルの名前を指定する。デフォルトはリンカの
      仕様によって決定される。
  <dt><code>-s <var>filename</var></code>
  <dd>スタートアップコード(リンクされる各モジュールの初期化ルーチン
      の呼び出しを行うコード)のファイル名を指定する。このファイルが
      リンクされる最初のモジュールとなる。デフォルトは -o オプション
      がある場合その値に先頭に "s_", 末尾に ".c" を加えたもの、
      -o オプションがない場合 a.c となる。
  <dt><code>-base <var>address</var></code>
  <dd>出力ファイルのベースアドレスを指定する。
      アドレスの書式は使用するリンカによる。
      環境によってはベースアドレスを指定することによって
      性能が向上すると言われている。
  <dt><code>-xm <var>module</var></code>
  <dd><code><var>module</var></code> で指定された標準モジュールを
      実行ファイルから除く。<br>
      <code><var>module</var></code> は次のうちのどれか。
      <table>
      <tr>
	<td valign=top><code>expand</code></td>
	<td>syntax-case によるhygienicマクロ機能。これが除かれると
	    一部の構文の振る舞いがわずかに変化するが、その変化は
	    普通のプログラムに影響を及ぼすようなものではない。</td>
      </tr>
      <tr>
	<td valign=top><code>stdmacro</code></td>
	<td>標準のマクロ。rhizome/pi では define, lambda など
	    基本的な構文キーワードもマクロなのでこれが除かれると
	    使用できなくなる。アプリケーションが実行時に任意の
	    式を評価する機能を持たないならこれを除いても安全
	    である。</td>
      </tr>
      <tr>
	<td valign=top><code>debugger</code></td>
	<td>デバッグ機能。<td>
      </tr>
      <tr>
	<td valign=top><code>stdproc</code></td>
	<td>組み込み手続きのうち rhizome/pi において scheme で
	    記述されているもの。これを除いた場合何が使用できなく
	    なるかはソースを参照のこと :-)
	    これを除くと <code>expand</code> と <code>debugger</code>
	    も自動的に除かれる。</td>
      </tr>
      <tr>
	<td valign=top><code>extcall</code></td>
	<td>共有オブジェクト内の関数へのインターフェースを提供するマクロ。
	    アプリケーションの実行時に新たに外部手続き、コールバック、
	    バッファ構造、定数を定義する必要がなければ
	    これを除いても安全である。</td>
      </tr>
      <tr>
	<td valign=top><code>saccess</code></td>
	<td><code>extcall</code>に含まれるマクロによって定義されたマクロを
	    展開するときに使用される手続き。<code>expand</code>が除かれると
	    <code>saccess</code>も自動的に除かれる。また<code>saccess</code>
	    が除かれると<code>extcall</code>が自動的に除かれる。</td>
      </tr>
      </table>
      <br>
      このオプションは複数指定できる。
  <dt><code>-aux <var>string</var></code>
  <dd><code><var>string</var></code> をリンカのコマンドラインに追加する。
      すでにオブジェクトファイルになっているモジュールを指定する目的に使用
      できる。<br>
      このオプションは複数指定できる。
</dl>
  <code><var>module-specifier</var></code> の指定方法
<p>
  <code><var>module-specifier</var></code> には pisc の <code>-module</code>
  オプションで指定した名前を指定する。<br>
  そのモジュールが含まれるファイルがモジュール名に ".c" を追加した名前で
  ない場合、ファイル名を ':' のあとに指定する。また、ファイルが既に
  オブジェクトファイルになっている場合は ':' のあとを空文字列にし、
  オブジェクトファイルの名前を -aux オプションを使用して指定する。
<p>
例<br>
ソースファイル x.scm, y.scm, z-0.scm をコンパイルして実行ファイルを
作成するとする。以下はコンパイルの手順の一例である。
<pre>
pisc x.scm				# x.c を生成
pisl -nold x				# x.o を生成
pisc y.scm				# y.c を生成
pisc -module zz -output z-0.c z-0.scm	# z-0.c を生成、モジュール名は zz
pisl -aux x.o x: y zz:z-0.c		# 実行ファイルを生成
</pre>
生成された実行ファイルを起動すると各ソースファイルをインタプリタ上で
pisl に与えたモジュール指定の順にロードした場合と同様の動作をする。
上の例では、a.scm の内容が
<pre>
	(load "x.scm")
	(load "y.scm")
	(load "z-0.scm")
</pre>
であったとして
<pre>
	pi a.scm [arguments]
</pre>
とした場合と同様の動作となる。<br>
特に、コンパイルしたプログラムが非対話的な一連の動作の後 <code>(exit)</code>
するようになっていれば、生成されるものは非対話的なプログラムになる。また、
一連の手続きの定義のみを含むプログラムをコンパイルすれば生成されるものは
その手続きがあらかじめ定義された scheme インタプリタとなる。ただしこの
場合起動時の第一引数をロードするといった pi と同じ動作を望むなら、その
動作をプログラムに記述しなければならない(ライブラリに含まれるモジュール rp_pi
をリンクすればよい。pi 自身は "<code>pisl -o pi rp_pi:</code>"
として作成できる。)<br>
同一のモジュールを2回以上ロードしてはならない。
これに違反した場合プログラムは異常終了する。
<hr>
<h5><a href="index.html#Others">インデックス</h5>
</body>
</html>
